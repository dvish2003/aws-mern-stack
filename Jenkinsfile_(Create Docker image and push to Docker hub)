pipeline {
    agent any

    environment {
        DOCKER_REPO_FE = 'dvish2003/mern-frontend'
        DOCKER_REPO_BE = 'dvish2003/mern-backend'
        DOCKER_USER   = 'dvish2003'
        EC2_USER      = 'ubuntu'
        EC2_IP        = '51.20.252.89'
        EC2_APP_DIR   = '/home/ubuntu'
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/dvish2003/aws-mern-stack.git'
            }
        }

        stage('Install & Test Backend') {
            steps {
                dir('backend') {
                    sh '''
                        npm install
                        npm test || echo "No backend tests"
                    '''
                }
            }
        }

        stage('Install & Test Frontend') {
            steps {
                dir('frontend') {
                    sh '''
                        npm install
                        npm test || echo "No frontend tests"
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    dir('frontend') {
                        sh "docker build -t ${DOCKER_REPO_FE}:latest ."
                    }
                    dir('backend') {
                        sh "docker build -t ${DOCKER_REPO_BE}:latest ."
                    }
                }
            }
        }

        stage('Login to DockerHub') {
            steps {
                withCredentials([
                    string(credentialsId: 'DOCKER_PASSWORD', variable: 'DOCKER_PASSWORD')
                ]) {
                    sh """
                    echo "\$DOCKER_PASSWORD" | docker login -u ${DOCKER_USER} --password-stdin
                    """
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                sh "docker push ${DOCKER_REPO_FE}:latest"
                sh "docker push ${DOCKER_REPO_BE}:latest"
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh-key']) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} << 'EOF'
                        set -e
                        echo "Connected to EC2"

                        cd ${EC2_APP_DIR}

                        docker pull ${DOCKER_REPO_FE}:latest
                        docker pull ${DOCKER_REPO_BE}:latest

                        docker compose down
                        docker compose up -d

                        docker ps
                        echo "Deploy finished successfully"
                    EOF
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            sh 'docker logout'
        }
    }
}
